name: Deploy Web Build

on:
    push:
        branches:
            - main
    workflow_dispatch:

permissions:
    contents: read
    pages: write # For deploy-pages job

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }} # Use branch name for concurrency
    cancel-in-progress: true

jobs:
    build:
        runs-on: ubuntu-latest
        outputs:
            pr_number: ${{ steps.pr_number.outputs.pr_number }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Cache export templates
              id: cache-templates
              uses: actions/cache@v4
              with:
                  path: ~/.local/share/godot/export_templates/4.6.stable
                  key: godot-export-templates-4.6-stable
                  restore-keys: |
                      godot-export-templates-4.6-stable

            - name: Setup Godot
              run: |
                  wget -q https://github.com/godotengine/godot/releases/download/4.6-stable/Godot_v4.6-stable_linux.x86_64.zip
                  unzip -q Godot_v4.6-stable_linux.x86_64.zip
                  chmod +x Godot_v4.6-stable_linux.x86_64
                  sudo mv Godot_v4.6-stable_linux.x86_64 /usr/local/bin/godot

            - name: Download and install export templates
              if: steps.cache-templates.outputs.cache-hit != 'true'
              run: |
                  mkdir -p ~/.local/share/godot/export_templates/4.6.stable
                  wget -q https://github.com/godotengine/godot/releases/download/4.6-stable/Godot_v4.6-stable_export_templates.tpz
                  unzip -q Godot_v4.6-stable_export_templates.tpz -d /tmp/templates
                  cp -r /tmp/templates/templates/* ~/.local/share/godot/export_templates/4.6.stable/

            - name: Export project
              run: |
                  mkdir -p export
                  godot --headless --export-release "Web"

            - name: Copy index.html
              run: cp index.html export/index.html

            - name: Add cache busting
              run: |
                  SHA=${{ github.sha }}
                  # First, bust the cache for game.js itself
                  sed -i "s|src=\"game.js\"|src=\"game.js?v=$SHA\"|" export/game.html
                  # Then, inject a script to wrap 'fetch' and bust cache for wasm/pck files
                  cat <<EOF > /tmp/snippet.js
                  <script>
                    const originalFetch = window.fetch;
                    window.fetch = (resource, init) => {
                      if (typeof resource === 'string' && (resource.endsWith('game.pck') || resource.endsWith('game.wasm'))) {
                        resource += '?v=$SHA';
                      }
                      return originalFetch(resource, init);
                    };
                  </script>
                  EOF
                  sed -i -e '/<body>/r /tmp/snippet.js' export/game.html

            - name: Generate version file
              run: |
                  if [ "${{ github.event_name }}" = "pull_request" ]; then
                    echo "pr-${{ github.event.pull_request.number }}" > export/version.txt
                  else
                    echo "main" > export/version.txt
                  fi
                  echo "${{ github.sha }}" >> export/version.txt
                  echo "$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> export/version.txt
              shell: bash

            - name: Create .nojekyll file
              run: |
                  touch export/.nojekyll

            - name: Setup Pages
              if: github.event_name != 'pull_request'
              uses: actions/configure-pages@v4

            - name: Upload artifact for GitHub Pages
              if: github.event_name != 'pull_request'
              uses: actions/upload-pages-artifact@v3
              with:
                  path: export

    deploy-pages:
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        runs-on: ubuntu-latest
        needs: build
        if: github.event_name != 'pull_request'
        steps:
            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4
